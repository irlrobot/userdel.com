---
layout: post
title: implementing smartcards
date: '2011-05-20T07:24:32+00:00'
tags:
- smartcards
- CA
- certificates
- windows
tumblr_url: http://userdel.com/post/5667230598/implementing-smartcards
---
A few days ago I asked my boss if he could buy some smartcard stuff for me to play with.  I’ve been interested in trying this out for awhile now, but I found while researching how to implement them there was the lack of a decent “How To” guide.  So here is my little guide on implementing smartcards for a small number of users in a Windows Domain as a demo project. 

First things first.  I did this using Windows 7 and a Windows 2003 Certificate Authority with the 2008 web pages installed.  You will need AD and a CA already up and running to do this.  Installing a CA is beyond the scope of this guide.  This guide should work with XP, Vista, or 7 clients and 2003 or 2008 CA server.
For this test I purchased some cards, readers, and software from http://www.smartcardfocus.us.  I bought ACOS5 cards, some Omnikey/HID 3121 readers, and the ACOS5 SDK which is the middleware you’ll need to put the certificates on the card.  I received everything very promptly and as ordered, so I’d definitely recommend www.smartcardfocus.us.  However, I will note that I did run into some issues with the ACS cards that I will detail later in this article.  For now let’s carry on to the implementation which will be the same regardless what hardware you purchase.
Your first step to actually implementing is to get the CA ready to hand out smartcard certificates.  You can do this one of two ways.  First you can create what is called a Certificate Enrollment Station where one PC and one user account is designated to hand out (request on behalf of) certificates for other users.  To do this you can follow these steps.  Or you can simply allow certain users to enroll themselves and request a Smartcard User certificate, which is what I did.
To allow users to enroll themselves you will need to enable the “Smartcard Users” certificate template on your CA and then grant Read and Enroll to those users you want to get smartcard certificates.  In my case I created a new security group in AD called “Smartcard Users” and just gave the permissions on that group.  Using the “Smartcard Users” template (as opposed to “Smartcard Logon”) will also allow your users to authenticate using their smartcards for Remote Desktop and also things like encrypted email.
Next you will want to make sure all your software is installed on the machines you will be using the smartcards with.  In my case I had to install the OmniKey card reader drivers and then the ACS middleware.  After installing the middleware I opened up the Admin Tool and “initialized” my smartcard which basically formatted and reset the PIN to 12345678.  Then using the Admin Tool I changed my PIN which must be 8-16 alphanumeric characters.  If you want to authenticate with the smartcard when you Remote Desktop a server or other computer, you can choose the Advanced install of the middleware and only check the “Card Tool” option (again this is for ACS software only) which is the only thing you need to simply log into something via RDP.
Now that you have your smartcard ready to go you will want to open Internet Explorer and go to your CA.  Click “Request a certificate”, then “advanced certificate request”, and finally “Create and submit a request to this CA”.  Change the Certificate Template to “Smartcard User” and change the CSP option to whatever middleware you purchased.  In my case for ACS my CSP was “Advanced Card Systems CSP v2.4”.  Optionally you can give the cert a friendly name like “Josh’s Smartcard” and then click submit.  Make sure your card is inserted in the reader before clicking submit.  You should now see your reader blinking like crazy and eventually be prompted for your PIN to enter.  When it’s done you should eventually see the screen change and you’ll need to click on “Install Certificate” with the smartcard still in the reader.  A bit more flashing and blinking and you should be done.
At this point you should be able to lock your workstation and then pick “Other Credentials” when logging back in and see the smartcard reader option.  Punch in your PIN and then you should be in!  If you installed the middleware on a server test out RDP as well.
Now I mentioned at the beginning that there were some issues with the equipment I purchased.  Let me elaborate on the problems I’m currently seeing.
Usually it will work just fine, but it’s a little slow to log in.  I insert my card, enter my PIN, and after about 15-20 seconds of the reader blinking like crazy it will log me into Windows.  Now 15 seconds isn’t exactly painstaking, but if you consider that it takes about 3-5 seconds to simply enter your password and hit enter it’s quite a bit slower. 
So I said usually it logs me in.  Sometimes when inserting the card and trying to log in after my PIN is entered it will seemingly hang.  The “Welcome” messages shows on the Windows screen and the card reader will blink a bit then just go solid green and nothing happens.  One of two things happens from here.  First either I can remove the card and then it will complete the login and I’m taken to the Desktop (I’d say 75% of the time this happens in this scenario).  Or I will get an error saying something like “Unable to contact the RPC server” and then I am stuck.  Trying to login using username/password doesn’t work and the computer will eventually reboot after about a minute.
I’ve also had a couple random crashes since installing the software.  Windows just pops up a dialogue box saying the system encountered a problem and will restart in one minute.  I’ve had this happen three times so far.  It happened once to one of my colleagues as well.  I’ve since reinstalled all the software and have not yet seen this again, though.
Finally, some of the options in the software don’t work.  For example, there is an option to lock the computer when the card is removed.  This does not work; none of my colleagues could get it to work either.  Also there is an option to start the software on Windows start and that does not work either.
I’ve read good things about Gemalto but the quote I got back for a handful of cards and readers was a little expensive for a demo project.  The ACS stuff was dirt cheap, but as they say you get what you pay for. 
Here is some more links that might be useful while helping you get your smartcard project going:
Basic checklist from TechNet
Using a certificate enrollment station or on 2008 R2
Configure “Smart Card” as default logon option - did not try this
Open source middleare for non-domain computers - did not try this but could be interesting for home use
