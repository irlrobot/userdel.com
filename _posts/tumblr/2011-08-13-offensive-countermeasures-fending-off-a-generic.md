---
layout: post
title: 'offensive countermeasures: fending off a generic phishing campaign'
date: '2011-08-13T09:34:00+00:00'
tags:
- ocm
- phishing
- fight back
tumblr_url: http://userdel.com/post/8868908258/offensive-countermeasures-fending-off-a-generic
---
Every once in awhile a generic phishing campaign gets through your spam firewalls and a ton of (l)users give up their credentials.  Those accounts in turn start getting abused to send out more spam or phishing emails and next thing you know your blacklisted and nobody can send mail to recipients outside your organization.  This is a best case scenario for a successful phishing attack.  Worst case?  A manager, or worse fellow IT worker, gives up their creds and next thing you know the bad guy is on your network in places you’d rather he not be and you’re scrambling for damage control.  So what can you do?
First you need to actually get a copy of the phishing email.  Communicate to your Help Desk and colleagues that any time a phishing email gets through you absolutely must get forwarded a copy.  You may also want to consider sticking an email address for a dummy or “honeypot” type account on some public facing webpages, somewhere you know it will be scraped and used in spam/phishing campaigns.  Just keep in mind you will start getting a little more mail than you’re used to, but at least you will be on the forefront of knowing when a spam/phishing email gets through your front line.  If you don’t know one got through then you can’t take action to mitigate it’s impact.
Once you get the phishing email take a look and it’s either going to be one of two types.  Either it will be a crappy email that simply requests you reply with your account information and maybe some other junk like phone number or address, or it will be the kind that tries to engage the user and get them to click on a link which subsequently has a form on a webpage asking for their username, password, and whatever else.  The second is much more dangerous and is the focus of this article. 

Either type, your first action should be to file abuse reports.  Most phishing attacks are sent from other compromised accounts.  Send an email to abuse@domain.com and postmaster@domain.com for the sending domain and also for any reply domain if it’s different.  This will hopefully get someones attention and prevent further emails from going out.  Next, if there is a URL in the email you should also file abuse reports with those domains so they can be shut down.  Most of the time it’s a compromised host or some free dynamic DNS type service.  If it’s from a known spammy domain you may not have any luck here, but keep reading on what else you can do in the mean time.
So if it’s a simple email requesting you reply with your info there isn’t a whole lot of options.  You should definitely block outgoing email to the reply email address and possibly domain so nobody can send out their info.  Check your mail logs for anyone that’s already replied and contact them, or better yet disable their accounts, so they can change their password.  Be sure to council them and make sure they don’t do it again.
Now if you get the second type of phishing email that contains a URL with some kind of web form asking for information you can do some other things.  Let’s look at an example.  Recently a phishing campaign got through that asked my users to “verify their account” by following a URL to http://tech–nology.cz.cc/school/use/www/form1.html.  PHPFormGenerator is extremely common among these quick and shoddy phishing websites because it’s fast and easy to setup.  Fortunately for us blue team guys it’s pretty easy to break this form.  Whenever you get a URL like this try playing with it a bit until you can directory listing or better an admin console.  In the above example you can simply go to http://tech–nology.cz.cc/school/use/www/admin/ and bam you’re in the admin section where you can see all submitted forms.  Keep playing with the URL until you find something useful.  Lookup default passwords for whatever software the bad guys might be using and try to get to that admin type interface.  In my experience it won’t take you long as most phishers are lazy or unskilled and use pre-canned “kits” they get from underground forums.
So now that you’re in the admin interface there is a couple options.  First, you should take note, and continue to monitor, of everyone who actually does submit their info.  Take down their names and save them from later so you can contact them back, tell them to change their password, and counsel them to never do it again!  Next you should try to delete, modify, or otherwise damage the form/webpage used in the phishing link.  Keep in mind this may be a compromised host so you want to minimize collateral damage and not outright destroy someones server.  If you can simply delete the form this may be the best option and then you can wait for your abuse report to be received and the site ultimately shut down.  If you can’t delete the form then you can take another countermeasure I like to call “spam the phishers”!
You can use a simple bash script to submit garbage into the phishing form over and over.  One of several things usually happen in this case.  First, you send so much that it will fill up disk space on the box and/or just crash the web, or possibly even database, server.  Second, if they are using a free hosting service the host may notice the increase in traffic or disk consumption and just shut down the domain.  Third, there will be so much garbage in there the phisher just gives up and moves on to their next target.  To accomplish this, first grab this perl script called formfind.pl which will help you determine how to submit the form via script.  Next, use curl or wget to grab a copy of the webpage that has the form.  Use the above perl script (formfind.pl < form.html) to find out all the fields and how to submit the form.  Then you can use a script containing a loop and something like:

curl -d “username=BLAH&password=LOL” ‘http://tech–nology.cz.cc/school/use/www/process.php’

This will submit the username of BLAH and password of LOL to our example form.  Do this once a second for awhile and you will eventually achieve one of the above results.
This isn’t the only thing you can do of course; use your imagination and some common sense though.  Remember, to operate within the bounds of your organization, use your judgement, and keep in mind this server may just be some other organizations compromised host (you should try to inform them of this!).   In the case of PHPFormGenerator you can try other tactics such as creating a new web form with an upload box in it and uploading large files to the server until it’s full, or maybe uploading something like PHPShell.  Get creative.
